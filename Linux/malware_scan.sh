#!/bin/bash

# =========================
# 🔍 Suspicious File & Malware Scanner
# =========================
# This script scans the system for:
# - Malware (ClamAV)
# - Suspicious file names or extensions
# - Hidden or world-writable files
# - Modified system binaries

LOGFILE="/var/log/malware_scan.log"
echo "[+] Malware Scan Started: $(date)" | tee -a $LOGFILE

# =========================
# 1️⃣ Check for ClamAV & Install If Missing
# =========================
if ! command -v clamscan &> /dev/null; then
    echo "[!] ClamAV not found. Installing..."
    if command -v apt &> /dev/null; then
        sudo apt update && sudo apt install -y clamav clamav-daemon
    elif command -v yum &> /dev/null; then
        sudo yum install -y clamav clamav-update
    elif command -v pacman &> /dev/null; then
        sudo pacman -Syu --noconfirm clamav
    elif command -v zypper &> /dev/null; then
        sudo zypper install -y clamav
    else
        echo "[X] Unsupported package manager. Install ClamAV manually."
        exit 1
    fi
fi

# =========================
# 2️⃣ Update ClamAV Database
# =========================
echo "[+] Updating ClamAV database..." | tee -a $LOGFILE
sudo freshclam

# =========================
# 3️⃣ Scan System for Malware
# =========================
echo "[+] Scanning system for malware..." | tee -a $LOGFILE
sudo clamscan -r --bell --log=$LOGFILE --infected /

# =========================
# 4️⃣ Find Suspicious File Extensions
# =========================
echo "[+] Searching for suspicious file extensions..." | tee -a $LOGFILE
find / -type f \( -name "*.exe" -o -name "*.bat" -o -name "*.scr" -o -name "*.ps1" -o -name "*.vbs" \) 2>/dev/null | tee -a $LOGFILE

# =========================
# 5️⃣ Find Hidden Files
# =========================
echo "[+] Finding hidden files (dotfiles outside user directories)..." | tee -a $LOGFILE
find / -type f -name ".*" -not -path "/home/*" -not -path "/root/*" 2>/dev/null | tee -a $LOGFILE

# =========================
# 6️⃣ Find World-Writable Files (Potential Security Risk)
# =========================
echo "[+] Checking for world-writable files..." | tee -a $LOGFILE
find / -type f -perm -0002 -exec ls -l {} \; 2>/dev/null | tee -a $LOGFILE

# =========================
# 7️⃣ Check for Modified System Binaries
# =========================
echo "[+] Checking for modified system binaries..." | tee -a $LOGFILE
sudo debsums -s 2>/dev/null | tee -a $LOGFILE  # Debian-based
rpm -Va 2>/dev/null | grep '^..5' | tee -a $LOGFILE  # RHEL-based

# =========================
# ✅ Scan Complete
# =========================
echo "[+] Malware scan completed. Log saved in: $LOGFILE" | tee -a $LOGFILE
