#!/bin/bash

# =========================
# Arch Linux Hardening Script
# =========================
# This script is designed for Arch Linux and its derivatives.
# It applies security configurations, audits logs, and stores them in a structured format.

LOGFILE="/security_hardening.log"
exec > >(tee -a "$LOGFILE") 2>&1  # Log all output to file

# =========================
# Updating System Packages
# =========================
echo "[+] Updating system packages..."
sudo pacman -Syu --noconfirm

# =========================
# Configuring Firewall (UFW)
# =========================
echo "[+] Configuring firewall (UFW)..."
sudo pacman -S --noconfirm ufw
sudo systemctl enable ufw
sudo systemctl start ufw
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw enable

# =========================
# Securing SSH
# =========================
echo "[+] Securing SSH..."
sudo sed -i 's/^#PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
sudo sed -i 's/^#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
echo "AllowUsers your_user" | sudo tee -a /etc/ssh/sshd_config  # Replace 'your_user' with your actual username
sudo systemctl restart sshd

# =========================
# Locking Root Account
# =========================
echo "[+] Locking root account..."
sudo passwd -l root

# =========================
# Setting Password Policies
# =========================
echo "[+] Setting password policies..."
sudo pacman -S --noconfirm libpwquality
sudo sed -i 's/^# minlen =.*/minlen = 12/' /etc/security/pwquality.conf
sudo sed -i 's/^# dcredit =.*/dcredit = -1/' /etc/security/pwquality.conf
sudo sed -i 's/^# ucredit =.*/ucredit = -1/' /etc/security/pwquality.conf
sudo sed -i 's/^# ocredit =.*/ocredit = -1/' /etc/security/pwquality.conf
sudo sed -i 's/^# lcredit =.*/lcredit = -1/' /etc/security/pwquality.conf

# =========================
# Installing Auditing Tools
# =========================
echo "[+] Installing auditing tools..."
sudo pacman -S --noconfirm audit
sudo systemctl enable auditd
sudo systemctl start auditd
cat <<EOF | sudo tee /etc/audit/rules.d/security.rules
-w /etc/passwd -p wa -k passwd_changes
-w /etc/shadow -p wa -k shadow_changes
-w /var/log/auth.log -p wa -k auth_logs
EOF
sudo augenrules --load

# =========================
# Configuring Fail2Ban
# =========================
echo "[+] Configuring Fail2Ban..."
sudo pacman -S --noconfirm fail2ban
cat <<EOF | sudo tee /etc/fail2ban/jail.local
[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 5
[sshd]
enabled = true
EOF
sudo systemctl enable fail2ban
sudo systemctl start fail2ban

# =========================
# Kernel and Network Hardening
# =========================
echo "[+] Setting kernel and network hardening..."
cat <<EOT | sudo tee /etc/sysctl.d/99-sysctl.conf
net.ipv4.conf.all.rp_filter = 1
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 2048
net.ipv4.conf.all.accept_redirects = 0
EOT
sudo sysctl --system

# =========================
# Scanning for Rootkits
# =========================
echo "[+] Scanning for rootkits..."
sudo pacman -S --noconfirm chkrootkit rkhunter
sudo chkrootkit
sudo rkhunter --update
sudo rkhunter --checkall

# =========================
# Checking for Cron Jobs
# =========================
echo "[+] Checking for cron jobs..."
echo "User Cron Jobs:" >> "$LOGFILE"
crontab -l >> "$LOGFILE"
echo "System-wide Cron Jobs:" >> "$LOGFILE"
cat /etc/crontab >> "$LOGFILE"
echo "Cron Job Directories:" >> "$LOGFILE"
ls -la /etc/cron.* >> "$LOGFILE"

# =========================
# Listing Active Services
# =========================
echo "[+] Listing active services..."
systemctl list-units --type=service --state=running >> "$LOGFILE"

# =========================
# Searching for .conf Files
# =========================
echo "[+] Searching for .conf files..."
find / -type f -name "*.conf" 2>/dev/null >> "$LOGFILE"

# =========================
# Hardening Complete
# =========================
echo "[+] Hardening complete. Logs saved in $LOGFILE"

